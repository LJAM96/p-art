<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P-Art</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-dark bg-dark">
        <div class="container-fluid flex-wrap align-items-center gap-2">
            <a class="navbar-brand" href="/">P-Art</a>
            <div class="navbar-nav flex-row flex-wrap gap-2">
                <a class="nav-link active" aria-current="page" href="/">Run</a>
                <a class="nav-link" href="/config">Configuration</a>
                <a class="nav-link" href="/approve">Approve Changes</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <h1>Run Artwork Update</h1>
        <form action="/run" method="post">
            <div class="form-check mb-3">
                <input class="form-check-input" type="checkbox" id="final_approval" name="final_approval" {% if config.final_approval %}checked{% endif %}>
                <label class="form-check-label" for="final_approval">Final Approval Mode</label>
            </div>
            <button type="submit" class="btn btn-primary" id="runButton" {% if is_running %}disabled{% endif %}>Run Now</button>
        </form>

        <div class="mt-4">
            <div class="d-flex justify-content-between align-items-center">
                <h2 class="h5 mb-0">Progress</h2>
                <span class="text-muted small" id="progress-status">Idle</span>
            </div>
            <div class="progress mt-2" style="height: 1.25rem;">
                <div id="progress-bar" class="progress-bar" role="progressbar" style="width: 0%;" aria-valuemin="0" aria-valuemax="100">0%</div>
            </div>
            <div class="mt-2 text-muted small" id="progress-detail">0 / 0 items</div>
        </div>

        <h2 class="mt-4">Logs</h2>
        <pre id="logs" class="p-3 bg-light border rounded" style="height: 360px; overflow-y: auto; white-space: pre-wrap; font-size: 0.9rem;"></pre>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const logsEl = document.getElementById('logs');
        const maxLogs = 200;
        const logLines = [];
        const progressBar = document.getElementById('progress-bar');
        const progressDetail = document.getElementById('progress-detail');
        const progressStatus = document.getElementById('progress-status');
        const runButton = document.getElementById('runButton');
        const initialProgress = {{ initial_progress | tojson }};

        function renderLogs() {
            logsEl.textContent = logLines.join('\n');
            logsEl.scrollTop = logsEl.scrollHeight;
        }

        function addLog(message) {
            logLines.push(message);
            if (logLines.length > maxLogs) {
                logLines.shift();
            }
            renderLogs();
        }

        function updateProgress(completed, total) {
            const safeTotal = total || 0;
            const safeCompleted = Math.min(completed || 0, safeTotal);
            const percent = safeTotal === 0 ? 0 : Math.round((safeCompleted / safeTotal) * 100);
            progressBar.style.width = percent + '%';
            progressBar.setAttribute('aria-valuenow', percent.toString());
            progressBar.textContent = percent + '%';
            progressDetail.textContent = `${safeCompleted} / ${safeTotal} items`;
        }

        function setStatus(state) {
            if (state === 'running') {
                progressStatus.textContent = 'Processing';
                runButton.disabled = true;
            } else {
                progressStatus.textContent = 'Idle';
                runButton.disabled = false;
            }
        }

        updateProgress(initialProgress.completed, initialProgress.total);
        setStatus({{ ('running' if is_running else 'idle') | tojson }});

        const source = new EventSource('/stream');
        source.onmessage = function(event) {
            try {
                const payload = JSON.parse(event.data);
                if (payload.type === 'log') {
                    addLog(payload.message);
                } else if (payload.type === 'progress') {
                    updateProgress(payload.completed, payload.total);
                } else if (payload.type === 'status') {
                    setStatus(payload.state);
                }
            } catch (err) {
                addLog(event.data);
            }
        };
    </script>
</body>
</html>
